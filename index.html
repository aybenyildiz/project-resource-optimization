<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Resource Optimization Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button { border-bottom: 2px solid transparent; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; font-weight: 500; color: #6b7280; white-space: nowrap; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; font-size: 0.75rem; }
        tbody tr:hover { background-color: #f9fafb; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: box-shadow 0.2s; font-size: 0.875rem; }
        input:focus, select:focus { box-shadow: 0 0 0 2px #bfdbfe; outline: none; border-color: #3b82f6;}
        .modal-overlay { transition: opacity 0.3s ease; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-screen-2xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6 border-b pb-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Project Resource Optimization Tool</h1>
            <div class="flex items-center space-x-2">
                 <div id="status-light" class="w-4 h-4 rounded-full bg-red-500 transition-colors" title="API Connection Status"></div>
                 <span id="status-text" class="text-sm text-gray-500">Checking API Connection...</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-7 gap-8">
            <div class="lg:col-span-3">
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex space-x-2 sm:space-x-4 overflow-x-auto" aria-label="Tabs">
                        <button class="tab-button active" data-tab="tab-activities">Activities</button>
                        <button class="tab-button" data-tab="tab-precedences">Precedences</button>
                        <button class="tab-button" data-tab="tab-resources">Resources</button>
                        <button class="tab-button" data-tab="tab-settings">Settings</button>
                    </nav>
                </div>
                
                <div id="tab-activities" class="tab-content active">
                    <div class="overflow-auto max-h-[500px] border rounded-lg">
                        <table class="min-w-full text-sm">
                            <thead class="sticky top-0 bg-gray-50"><tr><th>Project</th><th>Activity</th><th>Durations</th><th>Target Finish</th><th>Penalty</th><th>Resources</th><th></th></tr></thead>
                            <tbody id="activities-table-body"></tbody>
                        </table>
                    </div>
                    <button id="add-activity-btn" class="mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm flex items-center justify-center"><i class="fas fa-plus mr-2"></i>Add New Activity</button>
                </div>

                <div id="tab-precedences" class="tab-content">
                    <div class="space-y-4 p-4 border rounded-lg bg-gray-50">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                            <div>
                                <label for="predecessor-select" class="block text-sm font-medium text-gray-700">Predecessor Activity</label>
                                <select id="predecessor-select" class="mt-1"></select>
                            </div>
                            <div>
                                <label for="successor-select" class="block text-sm font-medium text-gray-700">Successor Activity</label>
                                <select id="successor-select" class="mt-1"></select>
                            </div>
                        </div>
                        <button id="add-precedence-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors text-sm"><i class="fas fa-plus mr-2"></i>Add Precedence</button>
                    </div>
                    <div class="mt-4 overflow-auto max-h-[400px] border rounded-lg">
                        <table class="min-w-full text-sm">
                            <thead class="sticky top-0 bg-gray-50"><tr><th>Predecessor</th><th>Successor</th><th></th></tr></thead>
                            <tbody id="precedences-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-resources" class="tab-content">
                     <div class="overflow-auto max-h-[500px] border rounded-lg">
                        <table class="min-w-full text-sm"><thead><tr><th>Resource</th><th>Capacity</th><th>Weight</th><th></th></tr></thead><tbody id="resources-table-body"></tbody></table>
                    </div>
                     <button id="add-resource-btn" class="mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm flex items-center justify-center"><i class="fas fa-plus mr-2"></i>Add New Resource</button>
                </div>
                
                <div id="tab-settings" class="tab-content space-y-4">
                    <div><label for="time_periods" class="block text-sm font-medium text-gray-700">Planning Horizon (Days)</label><input type="number" id="time_periods" value="10" class="mt-1"></div>
                    <div><label for="cost_per_day" class="block text-sm font-medium text-gray-700">Daily Activity Cost</label><input type="number" id="cost_per_day" value="0.1" step="0.1" class="mt-1"></div>
                </div>

                <button id="optimizeButton" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105 active:scale-95 flex items-center justify-center"><i class="fas fa-cogs mr-2"></i>Start Optimization</button>
            </div>

            <div class="lg:col-span-4">
                 <h2 class="text-lg font-semibold text-gray-700 mb-2">Optimization Results</h2>
                <div id="results-container" class="relative bg-gray-50 p-4 border border-gray-200 rounded-lg min-h-[500px]">
                    <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-75 flex flex-col items-center justify-center rounded-lg z-10"><div class="spinner mb-4"></div><p id="loading-text" class="text-gray-700 font-semibold">Optimization in progress, please wait...</p></div>
                    <div id="results-content" class="space-y-6"><p id="initial-message" class="text-gray-500 text-center pt-16">No optimization has been started yet. The results will be displayed here.</p><div id="summary-tables" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div><div id="gantt-container" class="hidden"><h3 class="text-md font-semibold text-gray-700 mb-2">Project Schedule (Gantt Chart)</h3><div class="w-full h-96 bg-white p-2 rounded-md shadow-inner"><canvas id="gantt-chart"></canvas></div></div><div id="resource-container" class="hidden"><h3 class="text-md font-semibold text-gray-700 mb-2">Daily Resource Usage Chart</h3><div class="w-full h-72 bg-white p-2 rounded-md shadow-inner"><canvas id="resource-chart"></canvas></div></div><details id="raw-json-details" class="hidden"><summary class="cursor-pointer text-sm text-gray-600">View Raw JSON Result</summary><pre id="output" class="text-xs whitespace-pre-wrap bg-gray-200 p-2 rounded mt-2 max-h-64 overflow-auto"></pre></details></div>
                </div>
            </div>
        </div>
    </div>

    <div id="resource-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-bold mb-4" id="modal-title">Resource Requirements</h3><div id="modal-body" class="space-y-3 max-h-64 overflow-y-auto"></div><div class="mt-6 flex justify-end space-x-3"><button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const activitiesTableBody = document.getElementById('activities-table-body');
            const resourcesTableBody = document.getElementById('resources-table-body');
            const precedencesTableBody = document.getElementById('precedences-table-body');
            const predecessorSelect = document.getElementById('predecessor-select');
            const successorSelect = document.getElementById('successor-select');
            const addPrecedenceBtn = document.getElementById('add-precedence-btn');
            const optimizeButton = document.getElementById('optimizeButton');
            const outputEl = document.getElementById('output');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const statusLight = document.getElementById('status-light');
            const statusText = document.getElementById('status-text');
            const initialMessage = document.getElementById('initial-message');
            const summaryTablesContainer = document.getElementById('summary-tables');
            const ganttContainer = document.getElementById('gantt-container');
            const resourceContainer = document.getElementById('resource-container');
            const rawJsonDetails = document.getElementById('raw-json-details');
            const resourceModal = document.getElementById('resource-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const API_BASE_URL = 'http://127.0.0.1:5000';
            let ganttChartInstance = null;
            let resourceChartInstance = null;
            let currentEditingRow = null;

            const checkApiStatus = async () => { try { await fetch(`${API_BASE_URL}/api/health`); statusLight.classList.replace('bg-red-500', 'bg-green-500'); statusText.textContent = 'API Connection Active'; } catch (error) { statusLight.classList.replace('bg-green-500', 'bg-red-500'); statusText.textContent = 'API Connection Lost'; } };
            checkApiStatus(); setInterval(checkApiStatus, 10000);

            const sample_data = { "projects": ["J1", "J2", "J3", "J4"], "activities": {"J1": ["A11", "A12", "A13"], "J2": ["A21", "A22"], "J3": ["A31", "A32", "A33"], "J4": ["A41", "A42"]}, "resources": ["R1", "R2"], "precedences": {"J1": [["A11", "A12"]], "J2": [["A21", "A22"]], "J3": [["A31", "A32"]], "J4": [["A41", "A42"]]}, "resource_requirements": {"A11,J1,R1": 2, "A11,J1,R2": 1, "A12,J1,R1": 1, "A12,J1,R2": 3, "A13,J1,R1": 3, "A13,J1,R2": 2, "A21,J2,R1": 4, "A21,J2,R2": 2, "A22,J2,R1": 2, "A22,J2,R2": 4, "A31,J3,R1": 3, "A31,J3,R2": 1, "A32,J3,R1": 2, "A32,J3,R2": 3, "A33,J3,R1": 1, "A33,J3,R2": 2, "A41,J4,R1": 2, "A41,J4,R2": 1, "A42,J4,R1": 3, "A42,J4,R2": 2}, "resource_weights": {"R1": 0.6, "R2": 0.4}, "earliest_start_times": {"J1": 1, "J2": 1, "J3": 1, "J4": 1}, "project_deadlines": {"J1": 20, "J2": 20, "J3": 20, "J4": 20}, "time_periods": 10, "max_resource_capacity": {"R1": 12, "R2": 15}, "target_finish_times": {"A11,J1": 3, "A12,J1": 6, "A13,J1": 7, "A21,J2": 5, "A22,J2": 5, "A31,J3": 4, "A32,J3": 8, "A33,J3": 10, "A41,J4": 5, "A42,J4": 9}, "lateness_penalties": {"A11,J1": 10, "A12,J1": 1000, "A13,J1": 2, "A21,J2": 8, "A22,J2": 5000, "A31,J3": 5, "A32,J3": 50, "A33,J3": 10, "A41,J4": 15, "A42,J4": 750}, "min_durations": {"A11,J1": 2, "A12,J1": 3, "A13,J1": 1, "A21,J2": 3, "A22,J2": 2, "A31,J3": 2, "A32,J3": 3, "A33,J3": 1, "A41,J4": 2, "A42,J4": 3}, "max_durations": {"A11,J1": 5, "A12,J1": 6, "A13,J1": 3, "A21,J2": 7, "A22,J2": 4, "A31,J3": 4, "A32,J3": 5, "A33,J3": 2, "A41,J4": 4, "A42,J4": 5}, "cost_per_day": 0.1 };
            
            function populateForms(data) {
                document.getElementById('time_periods').value = data.time_periods;
                document.getElementById('cost_per_day').value = data.cost_per_day;
                resourcesTableBody.innerHTML = '';
                data.resources.forEach(resName => addResourceRow(resName, data.max_resource_capacity[resName] || 0, data.resource_weights[resName] || 0));
                activitiesTableBody.innerHTML = '';
                for (const projName in data.activities) {
                    data.activities[projName].forEach(actName => {
                        const key = `${actName},${projName}`;
                        const reqs = Object.fromEntries(data.resources.map(res => [res, data.resource_requirements[`${key},${res}`] || 0]));
                        addActivityRow(projName, actName, data.min_durations[key], data.max_durations[key], data.target_finish_times[key], data.lateness_penalties[key], reqs);
                    });
                }
                updatePrecedenceDropdowns();
                precedencesTableBody.innerHTML = '';
                for (const proj in data.precedences) {
                    data.precedences[proj].forEach(([pred, succ]) => {
                        addPrecedenceRow(`${pred},${proj}`, `${succ},${proj}`);
                    });
                }
            }

            function addResourceRow(name = '', capacity = 10, weight = 0.5) { 
                const row = document.createElement('tr'); 
                row.innerHTML = `<td><input type="text" class="res-name" value="${name}"></td><td><input type="number" class="res-capacity" value="${capacity}" min="0"></td><td><input type="number" class="res-weight" value="${weight}" step="0.1" min="0" max="1"></td><td><button class="text-red-500 hover:text-red-700 remove-btn"><i class="fas fa-trash-alt"></i></button></td>`; 
                resourcesTableBody.appendChild(row); 
                row.querySelector('.remove-btn').addEventListener('click', () => row.remove()); 
            }

            function addActivityRow(proj = 'J1', act = 'A_New', min = 1, max = 5, target = 10, penalty = 10, reqs = {}) {
                const row = document.createElement('tr');
                row.dataset.resourceReqs = JSON.stringify(reqs);
                row.innerHTML = `<td><input type="text" class="act-proj" value="${proj}"></td><td><input type="text" class="act-name" value="${act}"></td><td><div class="flex items-center space-x-1"><input type="number" class="act-min-dur w-12" value="${min}" min="1" title="Min Duration"><span>-</span><input type="number" class="act-max-dur w-12" value="${max}" min="1" title="Max Duration"></div></td><td><input type="number" class="act-target-finish w-20" value="${target}" min="1"></td><td><input type="number" class="act-penalty w-20" value="${penalty}" min="0"></td><td><button class="text-blue-500 hover:text-blue-700 edit-res-btn"><i class="fas fa-sliders-h"></i></button></td><td><button class="text-red-500 hover:text-red-700 remove-btn"><i class="fas fa-trash-alt"></i></button></td>`;
                activitiesTableBody.appendChild(row);
                row.querySelector('.remove-btn').addEventListener('click', () => { row.remove(); updatePrecedenceDropdowns(); });
                row.querySelector('.edit-res-btn').addEventListener('click', () => openResourceModal(row));
            }
            
            function updatePrecedenceDropdowns() {
                const options = Array.from(activitiesTableBody.querySelectorAll('tr')).map(row => {
                    const projInput = row.querySelector('.act-proj');
                    const actInput = row.querySelector('.act-name');
                    if (!projInput || !actInput) return null;
                    const proj = projInput.value;
                    const act = actInput.value;
                    if (!proj || !act) return null;
                    const val = `${act},${proj}`;
                    const text = `${act} (${proj})`;
                    return `<option value="${val}">${text}</option>`;
                }).filter(Boolean).join('');
                predecessorSelect.innerHTML = options;
                successorSelect.innerHTML = options;
            }

            function addPrecedenceRow(predVal, succVal) {
                const existing = Array.from(precedencesTableBody.querySelectorAll('tr')).some(r => r.dataset.pred === predVal && r.dataset.succ === succVal);
                if (existing) return;
                const predOption = predecessorSelect.querySelector(`[value="${predVal}"]`);
                const succOption = successorSelect.querySelector(`[value="${succVal}"]`);
                if (!predOption || !succOption) return;
                const predText = predOption.textContent;
                const succText = succOption.textContent;
                const row = document.createElement('tr');
                row.dataset.pred = predVal;
                row.dataset.succ = succVal;
                row.innerHTML = `<td>${predText}</td><td>${succText}</td><td><button class="text-red-500 hover:text-red-700 remove-btn"><i class="fas fa-trash-alt"></i></button></td>`;
                precedencesTableBody.appendChild(row);
                row.querySelector('.remove-btn').addEventListener('click', () => row.remove());
            }

            addPrecedenceBtn.addEventListener('click', () => {
                const pred = predecessorSelect.value;
                const succ = successorSelect.value;
                if (pred && succ && pred !== succ) { addPrecedenceRow(pred, succ); } 
                else if (pred === succ) { alert('An activity cannot be its own predecessor.'); }
            });

            document.getElementById('add-activity-btn').addEventListener('click', () => { addActivityRow(); updatePrecedenceDropdowns(); });
            document.getElementById('add-resource-btn').addEventListener('click', () => addResourceRow());
            populateForms(sample_data);

            function openResourceModal(row) { currentEditingRow = row; const proj = row.querySelector('.act-proj').value; const act = row.querySelector('.act-name').value; modalTitle.textContent = `Resource Requirements for "${act}" (${proj})`; const currentReqs = JSON.parse(row.dataset.resourceReqs || '{}'); const allResources = Array.from(resourcesTableBody.querySelectorAll('.res-name')).map(input => input.value).filter(Boolean); modalBody.innerHTML = ''; if (allResources.length === 0) { modalBody.innerHTML = '<p class="text-gray-500">Please add at least one resource in the "Resources" tab first.</p>'; } else { allResources.forEach(resName => { const value = currentReqs[resName] || 0; const div = document.createElement('div'); div.className = 'flex items-center justify-between'; div.innerHTML = `<label for="res-${resName}" class="font-medium">${resName}</label><input type="number" id="res-${resName}" value="${value}" min="0" class="modal-res-input w-24" data-res-name="${resName}">`; modalBody.appendChild(div); }); } resourceModal.classList.remove('hidden'); }
            function closeResourceModal() { resourceModal.classList.add('hidden'); currentEditingRow = null; }
            function saveResourceReqs() { if (!currentEditingRow) return; const newReqs = {}; modalBody.querySelectorAll('.modal-res-input').forEach(input => { newReqs[input.dataset.resName] = parseInt(input.value) || 0; }); currentEditingRow.dataset.resourceReqs = JSON.stringify(newReqs); closeResourceModal(); }
            modalCancelBtn.addEventListener('click', closeResourceModal);
            modalSaveBtn.addEventListener('click', saveResourceReqs);

            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(item => item.classList.remove('active')); tab.classList.add('active'); const target = document.getElementById(tab.dataset.tab); tabContents.forEach(content => content.classList.remove('active')); target.classList.add('active'); }); });
            
            function collectDataFromForms() {
                const data = { projects: [], activities: {}, resources: [], precedences: {}, resource_requirements: {}, resource_weights: {}, earliest_start_times: {}, project_deadlines: {}, max_resource_capacity: {}, target_finish_times: {}, lateness_penalties: {}, min_durations: {}, max_durations: {} };
                data.time_periods = parseInt(document.getElementById('time_periods').value);
                data.cost_per_day = parseFloat(document.getElementById('cost_per_day').value);
                resourcesTableBody.querySelectorAll('tr').forEach(row => { const name = row.querySelector('.res-name').value; if (!name) return; data.resources.push(name); data.max_resource_capacity[name] = parseInt(row.querySelector('.res-capacity').value); data.resource_weights[name] = parseFloat(row.querySelector('.res-weight').value); });
                const projectSet = new Set();
                activitiesTableBody.querySelectorAll('tr').forEach(row => {
                    const proj = row.querySelector('.act-proj').value; const act = row.querySelector('.act-name').value; if (!proj || !act) return;
                    const key = `${act},${proj}`;
                    if (!data.activities[proj]) data.activities[proj] = [];
                    data.activities[proj].push(act);
                    projectSet.add(proj);
                    data.min_durations[key] = parseInt(row.querySelector('.act-min-dur').value);
                    data.max_durations[key] = parseInt(row.querySelector('.act-max-dur').value);
                    data.target_finish_times[key] = parseInt(row.querySelector('.act-target-finish').value);
                    data.lateness_penalties[key] = parseInt(row.querySelector('.act-penalty').value);
                    const reqs = JSON.parse(row.dataset.resourceReqs || '{}');
                    for (const resName in reqs) { data.resource_requirements[`${key},${resName}`] = reqs[resName]; }
                });
                data.projects = Array.from(projectSet);
                data.projects.forEach(proj => {
                    data.earliest_start_times[proj] = 1;
                    data.project_deadlines[proj] = data.time_periods * 2;
                });
                data.precedences = {};
                precedencesTableBody.querySelectorAll('tr').forEach(row => {
                    const [predAct, predProj] = row.dataset.pred.split(',');
                    const [succAct, succProj] = row.dataset.succ.split(',');
                    if (predProj !== succProj) return; 
                    if (!data.precedences[predProj]) data.precedences[predProj] = [];
                    data.precedences[predProj].push([predAct, succAct]);
                });
                return data;
            }

            optimizeButton.addEventListener('click', async () => { const jsonData = collectDataFromForms(); initialMessage.classList.add('hidden'); summaryTablesContainer.innerHTML = ''; ganttContainer.classList.add('hidden'); resourceContainer.classList.add('hidden'); rawJsonDetails.classList.add('hidden'); loadingOverlay.classList.remove('hidden'); optimizeButton.disabled = true; optimizeButton.classList.add('opacity-50', 'cursor-not-allowed'); try { const response = await fetch(`${API_BASE_URL}/api/optimize`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jsonData) }); if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`); const data = await response.json(); checkTaskStatus(data.task_id); } catch (error) { showError(`Could not start optimization: ${error.message}`); } });
            async function checkTaskStatus(taskId) { const statusUrl = `${API_BASE_URL}/api/status/${taskId}`; const intervalId = setInterval(async () => { try { const response = await fetch(statusUrl); if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`); const data = await response.json(); const state = data.state || data.status; loadingText.textContent = `Optimization in progress... Status: ${state}`; if (state === 'SUCCESS') { clearInterval(intervalId); showSuccess(data.result); } else if (state === 'FAILURE') { clearInterval(intervalId); showError(`Task failed: ${data.result || 'Unknown error. Check worker logs.'}`); } } catch (error) { clearInterval(intervalId); showError(`Could not get task status: ${error.message}`); } }, 2000); }
            function showSuccess(result) { loadingOverlay.classList.add('hidden'); outputEl.textContent = JSON.stringify(result, null, 4); renderResults(result); resetButton(); }
            function showError(message) { loadingOverlay.classList.add('hidden'); initialMessage.textContent = message; initialMessage.classList.remove('hidden', 'text-gray-500'); initialMessage.classList.add('text-red-600'); resetButton(); }
            function resetButton() { optimizeButton.disabled = false; optimizeButton.classList.remove('opacity-50', 'cursor-not-allowed'); }
            function renderResults(result) { if(!result || result.status !== 'Optimal') { showError("Optimization failed or a feasible solution was not found."); return; } ganttContainer.classList.remove('hidden'); resourceContainer.classList.remove('hidden'); rawJsonDetails.classList.remove('hidden'); renderSummaryTables(result); renderGanttChart(result); renderResourceChart(result); }
            function renderSummaryTables(result) { summaryTablesContainer.innerHTML = ''; const objectiveCard = `<div class="bg-blue-100 p-4 rounded-lg"><h4 class="font-bold text-blue-800">Objective Function Value</h4><p class="text-2xl font-light text-blue-900">${result.objective_value.toFixed(2)}</p></div>`; let peakUsageHtml = '<div class="bg-indigo-100 p-4 rounded-lg"><h4 class="font-bold text-indigo-800">Peak Resource Usage</h4><div class="space-y-1 mt-1">'; for(const [resource, value] of Object.entries(result.peak_resource_usage)) { peakUsageHtml += `<p class="text-indigo-900"><span class="font-semibold">${resource}:</span> ${value.toFixed(1)} units</p>`; } peakUsageHtml += '</div></div>'; summaryTablesContainer.innerHTML = objectiveCard + peakUsageHtml; }
            
            function renderGanttChart(result) {
                const planningHorizon = parseInt(document.getElementById('time_periods').value);
                const today = new Date();
                const addDays = (days) => dateFns.addDays(today, days);
                
                const tasks = result.schedule;
                const taskLabels = tasks.map(task => `${task.activity} (${task.project})`);
                const taskData = tasks.map(task => ({
                    x: [addDays(task.start - 1), addDays(task.finish)],
                    y: `${task.activity} (${task.project})`
                }));

                const ctx = document.getElementById('gantt-chart').getContext('2d');
                if (ganttChartInstance) ganttChartInstance.destroy();
                
                ganttChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: taskLabels.slice().reverse(),
                        datasets: [{ data: taskData.slice().reverse(), backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, barPercentage: 0.6, categoryPercentage: 0.7, borderSkipped: false }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { 
                                type: 'time', 
                                time: { unit: 'day', displayFormats: { day: 'd MMM' } }, 
                                min: addDays(0), 
                                max: addDays(planningHorizon), // UPDATED: Set max boundary of the chart
                                title: { display: true, text: 'Date' } 
                            },
                            y: { title: { display: true, text: 'Activities' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: (context) => { const start = new Date(context.raw.x[0]).toLocaleDateString('en-US'); const end = new Date(context.raw.x[1]).toLocaleDateString('en-US'); return `${context.label}: ${start} - ${end}`; } } }
                        }
                    }
                });
            }

            function renderResourceChart(result) {
                const planningHorizon = parseInt(document.getElementById('time_periods').value);
                const dailyUsage = result.daily_usage;
                const resources = Object.keys(result.peak_resource_usage);

                // UPDATED: Generate labels for the entire planning horizon
                const labels = Array.from({ length: planningHorizon }, (_, i) => `Day ${i + 1}`);

                const datasets = resources.map((resource, index) => {
                    // UPDATED: Map data against the full set of labels, using 0 for days with no usage data
                    const data = labels.map(label => {
                        const day = label.replace('Day ', '');
                        return dailyUsage[day]?.[resource] || 0;
                    });
                    const colors = [ { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgba(59, 130, 246, 1)' }, { bg: 'rgba(239, 68, 68, 0.2)', border: 'rgba(239, 68, 68, 1)' }, { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgba(16, 185, 129, 1)' } ];
                    const color = colors[index % colors.length];
                    return { label: resource, data: data, borderColor: color.border, backgroundColor: color.bg, fill: true, tension: 0.1 };
                });
                const ctx = document.getElementById('resource-chart').getContext('2d');
                if (resourceChartInstance) resourceChartInstance.destroy();
                resourceChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Units Used' } },
                            x: { title: { display: true, text: 'Time' } }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }
        });
    </script>
</body>
</html>